---
title: "Assignement 2"
output: "pdf_document"
date: "2024-01-10"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introduction :

This assignment consists of performing data cleaning and manipulation, and then some statistical analysis. 

## Dataset:

The dataset is retrieved from [Rwanda DHS (Demographic and Health Survey)](https://dhsprogram.com/Data/) 2020. The type of dataset used here is Household member. You will get data in two files: main SPSS File and Map File (for descriptions). 

Your Assignments steps:

1. Read the dataset in R.

```{r}
options(warn = -1)
# required package
library(haven)

# import data
houseH <- read_sav("DHS2020/RWPR81FL.sav")


# data dimension
(dims <-dim(houseH))


```
The dataset has `r dims[1]` observations and `r dims[2]` features

- Visualize, inspect and get familiar with the data
```{r}
# your code here
View(houseH) 
str(houseH) # Understanding the data structure (types, dimensions, column details).

data.frame(summary(houseH))  # summary statistics for each column

# top 6 rows
head(houseH)

# last 6 rows
tail(houseH)

# column names
names(houseH)

# counting missing values for columns
data.frame("Sum of Missing values by colmuns" = colSums(is.na(houseH)))

# identifying columns type
data.frame(sapply(houseH, class))

```
```{r}
 "haven_labelled" %in% class(houseH$HV025)

```


2. Select only few columns, important in this Assignments. They are the following: "HV001", "HV009", "HV010", "HV011", "HV014", "SHDISTRICT", "HV024", "HV025", "HV040", "HV227", "HV228", "HV270", "HV105", "HV106", "HML3", "HML4", "HML7",
  "HML10", "HML22", "HML32","HML33", "HML35"

```{r}
# your code here
columns <- c("HV001", "HV009", "HV010", "HV011", "HV014", "SHDISTRICT", "HV024", "HV025", "HV040", "HV227", "HV228", "HV270", "HV105", "HV106", "HML3", "HML4", "HML7",
  "HML10", "HML22", "HML32","HML33", "HML35")
df <- houseH[,columns]
```

  
3. Rename variables using the variable descriptions below. Give meaningful (short) name to the variables of your choice.

>* HV001= "Cluster number", -> "cluster_no"
>* HV009 = "Number of household members", -> "no_HH_member"
>* HV010 = "Number of eligible women in household", -> 
>* HV011 = "Number of eligible men in household", ->
>* HV014 = "Number of children 5 and under (de jure)", -> 
>* SHDISTRICT = "District (geographic area)", -> 
>* HV024 = "Region (provinces, corresponding values in a map file)", -> 
>* HV025 = "Type of place of residence (rural versus urban)", -> 
>* HV040 = "Cluster altitude in meters", -> 
>* HV227 = "Presence of mosquito bed net for sleeping", -> 
>* HV228 = "Number of children under 5 who slept under a mosquito bed net", -> 
>* HV270 = "Wealth index combined (an index based on various household assets indicating socio-economic  status)", -> 
>* HV105 = "Age of household members", -> 
>* HV106 = "Highest educational level attained by individuals", -> 
>* HML3 = "Net observed by interviewer", -> 
>* HML4 = "Months ago the net was obtained", -> 
>* HML7 = "Brand of net", -> 
>* HML10 = "Insecticide-Treated Net (ITN)", -> 
>* HML22 = "Obtained net from campaign, antenatal, or immunization visit", -> 
>* HML33= "Result of malaria measurement", -> 
>* HML32 = "Final result of malaria from blood smear test", -> 
>* HML35 = "Result of malaria rapid test" -> 

```{r}
new_names <- c("cluster_no","no_HH_member","no_elig_wom_HH","no_elig_men_HH","child_under_5years","district",
               "province","locality","cluster_alt_M","mosquito_net_yes","child_under_5years_net_yes",
               "socio-economic_status","HH_members_ages","education_level","net_observed",
               "months_since_net_obtained","net_brand","ITN","antenatal","malaria_blood_T_result",
               "malaria_measures","malaria_rapid_T_result")
length(new_names)


names(df) <- new_names

```




## Data cleaning

1. Inspect each variables, decode variable to its original unique variables. 
Example, Variable "HV024"(Region) has Unique values 1,2,3,4,5. Decode it to orginal Region Kigali, South, West, North, East
Use Map file to see the description of each values in data. 

```{r}

decode <- function(data){
  for(name in colnames(data)){
    if("haven_labelled" %in% class(data[[name]]) & (!name %in% c("HH_members_ages","months_since_net_obtained"))){
    data[name] <- as_factor(data[name])
   }
  }
 return(data)
}
  
df <- decode(df)


```


2. Handling Missing Values:

Determine columns with missing values. Devise the strategy to handle missing values: Deleting missing values, replacing missing values with mean or mode.
```{r}
options(warn = -1)
# your code
library(dplyr)
count_NA <- function(data){
  data <- sapply(data, function(x) sum(is.na(x))) %>% sort(decreasing = TRUE) %>% data.frame() %>% rename( "null_count" = 1) %>% mutate(null_proprition=paste0(round(null_count/nrow(df)*100,2),"%"))
  
  return(data)
}
count_NA(df)
```



```{r}
NA_imputer <- function(data){
  for(cname in colnames(Filter(function(col)  any(is.na(col)), data))){
    #print(paste(cname,":",names(sort(table(data[cname]), decreasing = T)[1])))
    if("factor" %in% class(data[[cname]])){
        data[cname][is.na(data[cname])] <- names(sort(table(data[[cname]]), decreasing = T)[1])

    }else{
      data[cname][is.na(data[cname])] <- as.integer(mean(data[[cname]], na.rm = T))

    }
  }
  return(data)
}

clean_df <- NA_imputer(df)

count_NA(clean_df)

```


3. Create new variables

>a. Create variable called "Old Mosquito" variable HML4 (Months ago the net was obtained). The created variable must binary with 1 when mosquito is more than 24 months old. 
>b. Create Variable "Average District altitude". Create this variable by averaging cluster altitude in each district. We have three variables HV001= "Cluster number", SHDISTRICT = "District (geographic area)" and HV040 = "Cluster altitude in meters". Filter out clusters in each district, do `mean` of cluster altitude in that district. 

```{r}
library(dplyr)
clean_df <- clean_df %>%
  mutate(
    'Old Mosquito' = ifelse(months_since_net_obtained > 24, 1, 0)
  ) %>%
  group_by(district) %>%
  mutate(
    'Average District Altitude' = mean(cluster_alt_M, na.rm = TRUE)
  ) %>%
  ungroup()

```


## Data visualizations: 

Produce visualization of your choice. At least each of these
- Bar plot
```{r}
# your code
library(ggplot2)
clean_df %>% 
  group_by(province, mosquito_net_yes) %>% 
  summarise(total_nets = n(), .groups = "drop") %>% 
  ggplot(aes(x = province, y = total_nets, fill = as.factor(mosquito_net_yes))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Household with Mosquito Nets Distribution by Province", 
    x = "Province", 
    y = "Household With Nets", 
    fill = "Has Mosquito Net  Yes/No"
  ) +
  geom_text(
    aes(label = total_nets),
    position = position_dodge(width = 0.9),
    vjust = -0.5,
    size = 3
  ) +
  theme_minimal()


```

```{r}
library(ggplot2)
clean_df %>% 
  group_by(locality, education_level) %>% 
  summarise(ed_lev_counts = n(), .groups = "drop") %>% 
  ggplot(aes(x = locality, y = ed_lev_counts, fill = as.factor(education_level))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Education Level Distribution by Locality", 
    x = "Locality", 
    y = "Count", 
    fill = "Education Levels"
  ) +
  geom_text(
    aes(label = ed_lev_counts),
    position = position_dodge(width = 0.9),
    vjust = -0.5,
    size = 3
  ) +
  theme_minimal()
```

- Pie plot
```{r}
# your code
props <- round(prop.table(table(clean_df$locality)) * 100,2)
 props %>% pie(  main = "Distribution of Household by Locality",
labels =paste(names(props), "(",as.numeric(props),"%)")) 
 

```
```{r}

 library(dplyr)

# Filter and calculate percentages for "Rural" locality only
props1 <- clean_df %>%
  filter(locality == "Rural") %>%
  count(antenatal) %>%
  mutate(percentage = round((n / sum(n)) * 100, 2))

props2 <- clean_df %>%
  filter(locality == "Urban") %>%
  count(antenatal) %>%
  mutate(percentage = round((n / sum(n)) * 100, 2))

# Create pie chart
#windows(width = 12, height = 6)
par(mfrow = c(1, 2))
pie(
  props1$percentage,
  main = "Rural Locality",
  labels = paste(props1$antenatal, "(", props1$percentage, "%)", sep = ""),
  col = rainbow(length(props1$percentage)), # Distinct colors for each slice
  cex = 0.5, # Adjust label size
  radius = .4
)
pie(
  props2$percentage,
  main = "Urban Locality",
  labels = paste(props2$antenatal, "(", props2$percentage, "%)", sep = ""),
  col = rainbow(length(props2$percentage)), # Distinct colors for each slice
  cex = 0.5 ,# Adjust label size
  radius = .4
)

```



- Histogram
```{r}
# your code
hist(clean_df$HH_members_ages, main = "Distribution of Household Ages", xlab = "Ages")
```

- Boxplot
```{r}
# your code
boxplot(clean_df$HH_members_ages)
```


## Statistical analysis

### Descriptive statistics

1. Use Variable "HML33" to filter out people who had Malaria measurement. 
```{r}
# your code
table(clean_df$malaria_measures)['Measured']

```

2. Calculate Malaria [Prevalence](https://dhsprogram.com/data/Guide-to-DHS-Statistics/Prevalence_of_Malaria_in_Children.htm) for both "Blood Smear" and "Rapid Test"
```{r}
# your code
table(clean_df$malaria_rapid_T_result)
round(table(clean_df$malaria_blood_T_result)['Positive']/length(clean_df$malaria_blood_T_result) * 100, 2) 


round(table(clean_df$malaria_rapid_T_result)['Positive']/length(clean_df$malaria_rapid_T_result) * 100, 2) 

```

3. Aggregate Prevalence at district Level
```{r}
# your code
dd <- clean_df %>% group_by(district) %>% mutate(
  RPT_prev = round(table(malaria_rapid_T_result)['Positive']/length(malaria_rapid_T_result) * 100,2 ),
  BT_prev = round(table(malaria_blood_T_result)['Positive']/length(malaria_blood_T_result) * 100,2 )
                                                 
                                                 )

aggregate(
  c(malaria_rapid_T_result,malaria_blood_T_result) ~ district, 
  data=clean_df, 
  FUN = function(el) round(sum(el == "Positive") / length(el) * 100,2)
  )

library(dplyr)

district_pre <- clean_df %>%
  group_by(district) %>%
  summarise(
    malaria_rapid_prevalence = round(sum(malaria_rapid_T_result == "Positive") / n() * 100, 2),
    malaria_blood_prevalence = round(sum(malaria_blood_T_result == "Positive") / n() * 100, 2)
  )


c <- c("district","RPT_prev","BT_prev")
unique(dd[c])

```

### Analytical Analysis
1. Compare the prevalence in both tests and state if they are different.

***Hint:*** Check `?` the documentations for `t.test` and `aov`.
```{r}
# your code
t.test(district_pre$malaria_rapid_prevalence, district_pre$malaria_blood_prevalence, paired = T)

t2 <-aov(data = district_pre, malaria_rapid_prevalence ~ malaria_blood_prevalence)

```
```{r}
summary(t2)
```

### Bonus

2. Using a statistical model of your choice, determine if there is a relationship between malaria prevalence in a district and its average altitude. 
```{r}
# your code
```